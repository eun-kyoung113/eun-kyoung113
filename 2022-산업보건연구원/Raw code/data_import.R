#install.packages("sas7bdat") # too slow
#library(sas7bdat)

# Is there a way to load a large SAS7BDAT dataset into R efficiently with fair speed?
# https://www.reddit.com/r/rstats/comments/mbpk6k/is_there_a_way_to_load_a_large_sas7bdat_dataset/
# install.packages("haven")
# install.packages("tidyverse")


# leukemia_raw = haven::read_sas("/shared/data/koshri/ref_leukemia_bz.sas7bdat")
# raw data 위치 : /shared/data/koshri/ref_leukemia_bz.csv --> fread()로 읽으면 됨

library(data.table)
setDTthreads(24) 

dt = as.data.table(leukemia_raw)
# save(dt, file="ref_leukemia_bz.csv", compress=FALSE)


### Data Quality check ###
### 업종 category 별 unique한 level ? ###
code<-read.csv("업종코드.csv")
table(is.na(dt$UP1)) # NA 없음

table(dt$UP1)
#         A        B        C        D        E        F        G        H        I        J        K        L        M        N        O        P 
#722570   749930   215080 50975062   265031  1150051 16564789 33770790  5888613 10064072  6407902  2456130  7380721 11845645  5842899  1133464  7407283 
#       Q        R        S        T        U 
#20052733  1684350  6162479     9633    13737 

unique(dt$UP1)
#[1] ""  "M" "J" "Q" "L" "H" "F" "N" "I" "C" "G" "P" "K" "S" "R" "A" "O" "E" "D" "B" "U" "T"
unique(code$UP1)
#[1] "A" "B" "C" "G" "F" "P" "Q" "D" "E" "H" "I" "J" "K" "L" "M" "N" "O" "R" "S" "T" "U"

table(is.na(dt$UP2)) # NA 없음
table(dt$UP2)
#           01       02       03       05       06       07       08       10       11       12       13       14       15       16       17       18 
#5586   452903   151487   145540    11134     7372   194389     2185  3368225   201875     8531  2945361  1713287   647102   839173  1118739  1799243 
#    19       20       21       22       23       24       25       26       27       28       29       30       31       32       33       34       35 
#80218  2599143   370082  3581842  1850600  1050700  6522985  3536356  1526802  3261616  7734216  2730376  1074203   861688  1552699   319713   253460 
#    36       37       38       39       41       42       45       46       47       49       50       51       52       55       56       58       59 
#11571   173755   962255    14041 15765041   799748  1197133 20731527 11842130  2758952   189715    18297  2921649   917966  9146106  4254328   509333 
#    60       61       62       63       64       65       66       68       70       71       72       73       74       75       76       84       85 
#168910   381482   544787   549062  1738044   157738   560348  7380721   622497  6017642  4163147  1042359  1616748  4226151   397271  1133464  7407283 
#     86       87       90       91       94       95       96       97       98       99 
#9843786 10208947   443175  1241175  1942788  2363372  1856319     9196      437    13737

unique(dt$UP2)
#[1] ""   "71" "72" "58" "86" "68" "49" "41" "74" "59" "55" "75" "26" "46" "85" "64" "47" "20" "23" "10" "25" "73" "13" "65" "28" "14" "31" "29" "56" "33"
#[31] "87" "94" "90" "22" "76" "18" "91" "52" "27" "24" "03" "63" "51" "50" "66" "16" "70" "34" "61" "11" "30" "15" "21" "19" "62" "45" "60" "84" "17" "96"
#[61] "38" "42" "95" "35" "32" "37" "01" "12" "07" "05" "06" "02" "36" "99" "97" "08" "39" "98"
unique(code$UP2)
#[1] "1"  "2"  "3"  "5"  "6"  "7"  "8"  "10" "45" "11" "46" "12" "13" "41" "42" "14" "15" "16" "85" "17" "86" "18" "19" "20" "21" "22" "23" "24" "25" "26" "27"
#[32] "28" "29" "30" "31" "32" "33" "35" "36" "37" "38" "39" "47" "50" "49" "51" "52" "55" "56" "58" "59" "60" "61" "62" "63" "64" "65" "66" "68" "69" "70" "71"
#[63] "72" "73" "74" "75" "84" "91" "94" "87" "90" "95" "96" "97" "98" "99" "A"  "B"  "C"  "D"  "E"  "F"  "G"  "H"  "I"  "J"  "K"  "L"  "M"  "N"  "O"  "P"  "Q" 
#[94] "R"  "S"  "T"  "U" 

table(is.na(dt$UP3)) # NA 없음
table(dt$UP3)
unique(dt$UP3)
#[1] ""    "711" "729" "581" "861" "681" "492" "412" "742" "591" "551" "741" "752" "262" "461" "856" "721" "464" "641" "476" "468" "201" "465" "493" "411"
#[26] "419" "233" "107" "251" "682" "264" "732" "139" "651" "102" "289" "582" "141" "463" "239" "313" "291" "713" "561" "331" "872" "949" "862" "901" "205"
#[51] "479" "204" "221" "759" "108" "761" "181" "259" "911" "471" "292" "649" "529" "712" "652" "272" "131" "241" "134" "031" "639" "642" "511" "751" "501"
#[76] "739" "661" "132" "631" "339" "222" "714" "662" "162" "702" "340" "467" "941" "612" "715" "232" "112" "303" "265" "151" "212" "106" "202" "477" "473"
#[101] "192" "311" "620" "203" "261" "231" "452" "285" "763" "602" "103" "701" "842" "902" "466" "179" "969" "284" "211" "172" "152" "381" "733" "475" "421"
#[126] "271" "334" "281" "753" "263" "961" "952" "144" "243" "474" "562" "601" "845" "653" "869" "912" "266" "351" "104" "521" "451" "312" "274" "422" "171"
#[151] "111" "333" "953" "182" "852" "843" "494" "101" "383" "424" "352" "472" "942" "426" "273" "320" "370" "512" "302" "382" "871" "012" "133" "592" "143"
#[176] "854" "120" "142" "242" "071" "332" "283" "319" "478" "462" "491" "051" "353" "423" "072" "453" "857" "502" "161" "062" "163" "301" "282" "252" "014"
#[201] "213" "105" "020" "032" "743" "191" "559" "853" "013" "011" "855" "061" "841" "863" "495" "951" "360" "762" "990" "052" "851" "844" "611" "731" "970"
#[226] "080" "390" "764" "425" "716" "981" "304" "982"

unique(code$UP3)
#[1] "1"   "11"  "12"  "13"  "14"  "15"  "2"   "20"  "3"   "31"  "32"  "5"   "51"  "52"  "6"   "61"  "62"  "7"   "71"  "72"  "8"   "80"  "10"  "101" "102" "103"
#[27] "104" "105" "106" "107" "452" "108" "453" "111" "461" "112" "462" "120" "131" "463" "132" "411" "133" "412" "134" "139" "421" "141" "422" "142" "143" "423"
#[53] "144" "424" "151" "152" "425" "451" "161" "854" "162" "855" "856" "163" "171" "857" "172" "861" "862" "179" "863" "181" "869" "464" "182" "191" "192" "201"
#[79] "202" "203" "204" "465" "205" "211" "466" "212" "213" "221" "467" "222" "16"  "17"  "231" "232" "233" "239" "18"  "241" "242" "19"  "243" "251" "252" "259"
#[105] "21"  "22"  "261" "262" "23"  "24"  "263" "264" "265" "266" "271" "272" "273" "25"  "274" "281" "26"  "282" "283" "284" "285" "27"  "289" "291" "292" "28" 
#[131] "301" "302" "29"  "303" "311" "312" "313" "319" "320" "331" "30"  "332" "333" "334" "339" "351" "352" "353" "360" "370" "381" "382" "383" "390" "419" "33" 
#[157] "35"  "36"  "37"  "38"  "39"  "41"  "42"  "468" "471" "45"  "472" "46"  "47"  "502" "473" "49"  "511" "512" "474" "50"  "521" "529" "475" "476" "551" "477"
#[183] "559" "561" "478" "562" "55"  "581" "479" "582" "491" "492" "56"  "591" "493" "592" "494" "58"  "601" "495" "602" "501" "59"  "611" "612" "60"  "620" "631"
#[209] "639" "641" "642" "649" "63"  "651" "652" "653" "64"  "661" "662" "65"  "681" "682" "66"  "691" "692" "693" "694" "68"  "701" "702" "69"  "711" "712" "713"
#[235] "714" "715" "70"  "721" "729" "731" "732" "733" "739" "741" "742" "743" "73"  "751" "752" "753" "759" "74"  "841" "842" "843" "844" "845" "75"  "851" "852"
#[261] "853" "911" "912" "84"  "941" "85"  "871" "872" "86"  "901" "902" "87"  "90"  "905" "91"  "94"  "942" "949" "95"  "951" "952" "953" "96"  "961" "969" "97" 
#[287] "970" "98"  "981" "982" "99"  "990" "A"   "B"   "C"   "D"   "E"   "F"   "G"   "H"   "I"   "J"   "K"   "L"   "M"   "N"   "O"   "P"   "Q"   "R"   "S"   "T"  
#[313] "U"

### 모든 사업장별, 나이대별, SEX 별 누적근로자수, 누적발생건수가 단조증가하는지 확인 ###
check_increase<-function(x){
  a<-x[-1]
  a[(length(a)+1)]<-x[length(x)]
  a-x<0
}

library(dplyr)
df_check<-dt%>%group_by(INDDIS_NO,UP1, UP2, UP3, SEX, ECNY_AGE)%>%
  summarise(check_increase_ENR_BZ=lapply(ENR_BZ,check_increase) , check_increase_LEUKEMIA_BZ=lapply(LEUKEMIA_BZ,check_increase))
df_check<-as.data.frame(df_check)
sum(as.numeric(df_check$check_increase_ENR_BZ))
#[1] 0
sum(as.numeric(df_check$check_increase_LEUKEMIA_BZ))
#[1] 0

### 사업장 대분류 category별 year에 따른 CNS_BZ, ENR_BZ graph 그리기 ###
library(ggplot2)
dt_graph<-dt%>%group_by(UP1,YEAR)%>%summarise(sum_LEUKEMIA_BZ=sum(LEUKEMIA_BZ),sum_ENR_BZ=sum(ENR_BZ))
ggplot(dt_graph, aes(x=YEAR,y=sum_LEUKEMIA_BZ,group=UP1,colour=UP1)) + 
  geom_line()
ggplot(dt_graph, aes(x=YEAR,y=sum_ENR_BZ,group=UP1,colour=UP1)) + 
  geom_line()
